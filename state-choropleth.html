<!DOCTYPE html>
<meta charset="utf-8">
<style>
 
.states {
  fill: none;
  stroke: #000;
  stroke-linejoin: round;
}
 
.q0-9 { fill:rgb(247,251,255); }
.q1-9 { fill:rgb(222,235,247); }
.q2-9 { fill:rgb(198,219,239); }
.q3-9 { fill:rgb(158,202,225); }
.q4-9 { fill:rgb(107,174,214); }
.q5-9 { fill:rgb(66,146,198); }
.q6-9 { fill:rgb(33,113,181); }
.q7-9 { fill:rgb(8,81,156); }
.q8-9 { fill:rgb(8,48,107); }

#map path:hover {
  fill: red;
  fill-opacity: 0.7;
}

 
</style>
<h3 id="caption">Hover over a state:</h3>

<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/queue.v1.min.js"></script>
<script src="http://d3js.org/topojson.v0.min.js"></script>
<script>
 
var width = 960,
    height = 500;

var quantizeresp = d3.scale.quantize()
    .domain([.04, .17])
    .range(d3.range(9).map(function(i) { return "q" + i + "-9"; }));
	
var quantizepred = d3.scale.quantize()
    .domain([.07, .13])
    .range(d3.range(9).map(function(i) { return "q" + i + "-9"; }));
	
var quantizediff = d3.scale.quantize()
    .domain([0, .04])
    .range(d3.range(9).map(function(i) { return "q" + i + "-9"; }));
 
var path = d3.geo.path();
 
var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);
 
queue()
    .defer(d3.json, "us-10m.json")
    .defer(d3.csv, "state-choropleth.csv")
	.defer(d3.tsv, "us-state-names.tsv")
    .await(ready);
  

function ready(error, us, asthmadata, statenames) {
  var responseData = {};
  var predictedData = {};
  var differenceData = {};
  

  
  asthmadata.forEach(function(d) { responseData[d.State] = +d.Response; });
  asthmadata.forEach(function(d) { predictedData[d.State] = +d.Predicted; });
  asthmadata.forEach(function(d) { differenceData[d.State] = +d.Difference; });

  var select = d3.select("body").append("select");
  

  var parameters = ["Response","Predicted","Difference"];
  select.selectAll("option")
	.data(parameters)
	.enter().append("option")
	.attr("value", function(d){return d;})
	.text(function(d){return d;});

  select.on("change",function(){
	var parameter = parameters[this.selectedIndex];
	updateMap(parameter);	
	});
  var g = svg.append("g")
	.attr("class", "states")
	.attr("id", "map");
  
  updateMap("Response");

  function updateMap(parameter){
	  var names = {};
	  statenames.forEach(function(d){
		  names[d.id] = d.name;
		});
	  asthmadata.forEach(function(d){
		if(parameter=="Response"){r = d.Response*100;}
		if(parameter=="Predicted"){r = d.Predicted*100;}
		if(parameter=="Difference"){r = d.Difference*100;}
		names[d.State] = names[d.State] + ": " + r.toFixed(1) + "%";
	  });

	g.selectAll("path").remove();
    var paths = g.selectAll("path")
      .data(topojson.object(us, us.objects.states).geometries)
    .enter().append("path")
      .attr("class", function(d) {
	  if(parameter==="Response"){
		
		return quantizeresp(responseData[d.id]);
	  
	  } else if(parameter==="Predicted"){
		
		return quantizepred(predictedData[d.id]);
		
	  } else{
		
		return quantizediff(differenceData[d.id])};
	  
	  })


      .attr("d", path)
	  .on("mouseover",showCaption)
	  .on("mouseout",function(){caption.html(starter);});
  var caption = d3.select('#caption')
  ,starter = caption.html();

  function showCaption(d,i) {
    var name = names[d.id];
    caption.html(name);
  }
}
}
</script>
